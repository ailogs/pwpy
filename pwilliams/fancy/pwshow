#! /usr/bin/env python

import sys, os.path, miriad, ndshow, numpy as N
from mirtask import util

fft = '-f' in sys.argv
if fft:
    sys.argv.remove ('-f')

if len (sys.argv) < 2:
    util.die ('usage: pwshow [-f] <image>')

anyfailures = False

for path in sys.argv[1:]:
    data = None

    if os.path.exists (os.path.join (path, 'image')):
        h = miriad.ImData (path).open ('rw')
        data = h.readPlane (axes=[], topIsZero=True)
        h.close ()
    elif os.path.exists (os.path.join (path, 'table.dat')):
        import pyrap.tables
        t = pyrap.tables.table (path, ack=False)
        data = t.getcol ('map', nrow=1)[0]
        t.close ()
        data = N.squeeze (data)
        data = N.flipud (data) # same topIsZero issue as MIRIAD
    elif os.path.isfile (path):
        f = open (path, 'rb')
        sniff = f.read (9)
        f.close ()

        if sniff.startswith ('SIMPLE  ='):
            import pyfits
            hdulist = pyfits.open (path, mode='readonly')
            data = hdulist[0].data
            hdulist.close ()
            data = N.squeeze (data)
            data = N.flipud (data) # same topIsZero issue as MIRIAD

    if data is None:
        print >>sys.stderr, 'pwshow: don\'t know what to do with path "%s"' % path
        anyfailures = True
        continue

    if fft:
        data = N.abs (N.fft.ifftshift (N.fft.fft2 (N.fft.fftshift (data))))

    ndshow.view (data)

if anyfailures:
    sys.exit (1)
