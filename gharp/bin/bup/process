#!/bin/tcsh

if ($#argv < 2) then
	echo "Must give a cal-dataset and gps-dataset"
	exit(0)
endif

rm -r *-xx
rm -r *-yy
rm -r *-aver
rm -r *-cald

set cal=$1
set vis=$2

# after newcalcal has done its wonderful flagging, uvaver the cal data
uvaver vis=$cal out=$cal-aver options=nocal interval=0.5 line=chan,1,600,201 select="pol(xx,yy),-auto"
uvcat vis=$cal-aver out=$cal-xx select="pol(xx)"
uvcat vis=$cal-aver out=$cal-yy select="pol(yy)"

# average and break gps data into x and y pols
uvaver vis=$vis out=$vis-aver options=nocal interval=.05 line=chan,1,100,100 select="pol(xx,yy),-auto"
uvcat vis=$vis-aver out=$vis-xx select="pol(xx)"
uvcat vis=$vis-aver out=$vis-yy select="pol(yy)"

# flag the gps data
#uvflag vis=$vis-xx flagval=flag select="ant(11)(12)"
#uvflag vis=$vis-yy flagval=flag select="ant(11)(12)"

# selfcal the calibrator and copy to other files
selfcal vis=$cal-yy select=-auto options=smooth interval=45 refant=1
selfcal vis=$cal-xx select=-auto options=smooth interval=45 refant=1
gpcopy vis=$cal-xx options=nopass out=$vis-xx
gpcopy vis=$cal-yy options=nopass out=$vis-yy

puthd in=$vis-xx/interval value=100
puthd in=$vis-yy/interval value=100
puthd in=$cal-xx/interval value=100
puthd in=$cal-yy/interval value=100

# rejoin the files into one
uvcat vis=$cal-xx,$cal-yy out=$cal-cald
uvcat vis=$vis-xx,$vis-yy out=$vis-cald

