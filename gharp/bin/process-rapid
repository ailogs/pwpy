#!/bin/tcsh

if ($#argv < 3) then
	echo "Must give a cal-dataset and vis-dataset and full sefd file path corresponding to cal-dataset"
	exit(0)
endif

set cal=$1
set vis=$2
set sefdpath=$3

rm -rf $cal-xx-aver
rm -rf $cal-yy-aver
rm -rf $vis-xx-aver
rm -rf $vis-yy-aver
rm -rf $cal-xx
rm -rf $cal-yy
rm -rf $vis-xx
rm -rf $vis-yy
rm -rf $cal-xx-aver_tsys
rm -rf $cal-yy-aver_tsys
rm -rf $cal-xx-cald
rm -rf $cal-yy-cald
rm -rf $vis-xx-aver_tsys
rm -rf $vis-yy-aver_tsys
rm -rf $vis-xx-cald
rm -rf $vis-yy-cald
rm -rf $vis-cald
rm -rf $cal-cald

set line=chan,1,100,825
set tsys=300

# THIS PROGRAM ASSUMES YOU"VE ALREADY DONE NEWCALCAL AND ANTENNA FLAGGING

# apply gains, separate the polarizations
gpcopy vis=$cal/gains.xx out=$cal
uvcat vis=$cal out=$cal-xx select="pol(xx)"
gpcopy vis=$cal/gains.yy out=$cal
uvcat vis=$cal out=$cal-yy select="pol(yy)"
gpcopy vis=$cal/gains.xx out=$vis
uvcat vis=$vis out=$vis-xx select="pol(xx)"
gpcopy vis=$cal/gains.yy out=$vis
uvcat vis=$vis out=$vis-yy select="pol(yy)"

# uvaver the data
set dump=0.004167 # note that dump rate is in minutes
uvaver vis=$cal-xx out=$cal-xx-aver interval=10 line=$line 
uvaver vis=$cal-yy out=$cal-yy-aver interval=10 line=$line 
uvaver vis=$vis-xx out=$vis-xx-aver interval=$dump line=$line 
uvaver vis=$vis-yy out=$vis-yy-aver interval=$dump line=$line 

mv $vis-xx $vis-xx-aver  
mv $vis-yy $vis-yy-aver  
# put the system temperatures into the polarized data
# also, flags bad antennas
ApplySEFD.rb $sefdpath $cal-xx-aver $tsys 
ApplySEFD.rb $sefdpath $cal-yy-aver $tsys
ApplySEFD.rb $sefdpath $vis-xx-aver $tsys
ApplySEFD.rb $sefdpath $vis-yy-aver $tsys

# selfcal the calibrator and copy to other files
#selfcal vis=$cal-yy-aver_tsys select=-auto options=smooth interval=60 
#selfcal vis=$cal-xx-aver_tsys select=-auto options=smooth interval=60 
#gpcopy vis=$cal-xx-aver_tsys out=$vis-xx-aver_tsys
#gpcopy vis=$cal-yy-aver_tsys out=$vis-yy-aver_tsys

# Calibrations are good for 100 minutes
puthd in=$vis-xx-aver_tsys/interval value=100
puthd in=$vis-yy-aver_tsys/interval value=100 
puthd in=$cal-xx-aver_tsys/interval value=100
puthd in=$cal-yy-aver_tsys/interval value=100

# apply gain corrections
echo "Note, cannot recombine x's and y's until invert routine."
uvcat vis=$vis-xx-aver_tsys out=$vis-xx-cald
uvcat vis=$vis-yy-aver_tsys out=$vis-yy-cald
uvcat vis=$cal-xx-aver_tsys out=$cal-xx-cald
uvcat vis=$cal-yy-aver_tsys out=$cal-yy-cald

rm -rf $cal-xx-aver
rm -rf $cal-yy-aver
rm -rf $vis-xx-aver
rm -rf $vis-yy-aver
rm -rf $cal-xx
rm -rf $cal-yy
rm -rf $vis-xx
rm -rf $vis-yy
rm -rf $vis-xx-aver_tsys
rm -rf $vis-yy-aver_tsys
rm -rf $cal-xx-aver_tsys
rm -rf $cal-yy-aver_tsys


